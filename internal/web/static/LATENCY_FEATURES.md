# BoomDNS 延迟统计功能说明

## 🆕 新增功能

### 1. 实时延迟监控
- **响应时间跟踪**: 记录每次DNS查询的响应时间
- **毫秒级精度**: 精确到毫秒的延迟测量
- **实时更新**: 每次查询后立即更新统计

### 2. 多维度统计
- **总体统计**: 所有查询的延迟汇总
- **路由统计**: 按路由类型分别统计延迟
- **趋势分析**: 最小、最大、平均延迟对比

### 3. 智能路由分析
- **中国路由**: 国内域名解析延迟统计
- **国际路由**: 国外域名解析延迟统计
- **广告拦截**: 广告域名拦截延迟统计
- **缓存命中**: 缓存查询响应时间

## 📊 统计指标

### 总体指标
- **总查询数**: 累计DNS查询次数
- **总延迟**: 所有查询延迟总和
- **平均延迟**: 总延迟除以总查询数
- **最小延迟**: 单次查询最快响应时间
- **最大延迟**: 单次查询最慢响应时间

### 路由指标
- **查询次数**: 该路由的查询数量
- **平均延迟**: 该路由的平均响应时间
- **最小延迟**: 该路由的最快响应时间
- **最大延迟**: 该路由的最慢响应时间
- **最后更新**: 该路由最后查询时间

## 🔧 技术实现

### 延迟计算
```go
// 记录查询开始时间
startTime := time.Now()

// 执行DNS查询
resp, err := s.forward(ctx, req, upstreams, decision)

// 计算延迟
latency := time.Since(startTime)

// 更新统计
s.updateLatencyStats(decision, latency)
```

### 统计更新
- **线程安全**: 使用互斥锁保护统计数据
- **原子操作**: 延迟计算和统计更新原子化
- **实时计算**: 每次查询后立即更新平均值

### 数据存储
- **内存存储**: 统计数据存储在内存中
- **JSON格式**: API返回标准JSON格式
- **毫秒单位**: 所有延迟数据以毫秒为单位

## 📱 界面展示

### 统计卡片
```
┌─────────────────────────────────────┐
│ ⏱️ 平均延迟                         │
│ 48ms                                │
└─────────────────────────────────────┘
```

### 详情统计
```
┌─────────────────────────────────────┐
│ 延迟统计详情                        │
├─────────────────────────────────────┤
│ 总查询数: 5    最小延迟: 30ms       │
│ 最大延迟: 99ms  总延迟: 242ms       │
└─────────────────────────────────────┘
```

### 路由统计表格
```
┌─────────┬─────────┬─────────────┬─────────────┬─────────────┬─────────────┐
│ 路由    │ 查询数  │ 平均延迟    │ 最小延迟    │ 最大延迟    │ 最后更新    │
├─────────┼─────────┼─────────────┼─────────────┼─────────────┼─────────────┤
│ 🇨🇳中国  │ 3       │ 58ms        │ 38ms        │ 99ms        │ 09:30:41    │
│ 🌍国际   │ 2       │ 33ms        │ 30ms        │ 36ms        │ 09:30:41    │
└─────────┴─────────┴─────────────┴─────────────┴─────────────┴─────────────┘
```

## 🚀 使用方法

### 1. 查看延迟统计
- 打开Web界面: `http://localhost:8080`
- 查看"平均延迟"统计卡片
- 点击"延迟统计详情"查看详细信息

### 2. 监控路由性能
- 观察不同路由的延迟差异
- 识别性能瓶颈和优化机会
- 监控网络质量变化

### 3. 性能优化
- 分析高延迟查询的原因
- 优化上游DNS服务器配置
- 调整路由策略和缓存设置

## 💡 使用场景

### 运维监控
- **性能监控**: 实时监控DNS解析性能
- **故障排查**: 快速定位网络问题
- **容量规划**: 评估服务器负载能力

### 网络优化
- **路由优化**: 选择最优的上游服务器
- **缓存策略**: 优化缓存命中率
- **负载均衡**: 平衡不同路由的负载

### 用户体验
- **响应时间**: 监控用户查询响应时间
- **服务质量**: 确保DNS服务稳定性
- **性能报告**: 生成性能分析报告

## 🔍 性能分析

### 延迟分类
- **优秀**: < 50ms (本地网络)
- **良好**: 50-100ms (国内网络)
- **一般**: 100-200ms (国际网络)
- **较差**: > 200ms (网络问题)

### 优化建议
1. **本地缓存**: 提高缓存命中率
2. **上游选择**: 选择延迟最低的上游
3. **网络优化**: 改善网络连接质量
4. **负载分散**: 避免单点瓶颈

## 📈 监控指标

### 关键指标
- **平均延迟**: 整体性能表现
- **延迟分布**: 延迟的分布情况
- **路由性能**: 各路由的性能对比
- **趋势变化**: 性能随时间的变化

### 告警阈值
- **警告**: 平均延迟 > 100ms
- **严重**: 平均延迟 > 500ms
- **紧急**: 平均延迟 > 1000ms

## 🔧 API接口

### 获取延迟统计
```bash
GET /api/latency/stats
```

### 响应格式
```json
{
  "total_queries": 5,
  "total_latency_ms": 242,
  "min_latency_ms": 30,
  "max_latency_ms": 99,
  "avg_latency_ms": 48,
  "route_stats": {
    "china": {
      "count": 3,
      "total_latency_ms": 176,
      "min_latency_ms": 38,
      "max_latency_ms": 99,
      "avg_latency_ms": 58,
      "last_updated": "2025-08-12T09:30:41+08:00"
    }
  }
}
```

## 🎯 最佳实践

### 监控策略
1. **实时监控**: 持续监控延迟变化
2. **趋势分析**: 分析长期性能趋势
3. **异常检测**: 及时发现性能异常
4. **容量规划**: 基于性能数据规划容量

### 优化策略
1. **缓存优化**: 提高缓存命中率
2. **上游优化**: 选择最优上游服务器
3. **网络优化**: 改善网络连接
4. **负载均衡**: 分散查询负载

### 故障处理
1. **快速响应**: 延迟异常时快速响应
2. **根因分析**: 分析延迟异常原因
3. **优化措施**: 实施针对性的优化
4. **效果验证**: 验证优化效果
